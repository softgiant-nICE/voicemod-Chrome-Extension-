/*! For license information please see injected.js.LICENSE.txt */
(()=>{"use strict";class e{constructor(e){this.config=e}write(){"prod"!==this.config&&console.log(Array.from(arguments))}write_method_call({obj:e,class_name:t,method_name:n,args:r,output:o,error:a,stub:s,stack:i,ignore:c}){if(!c&&"prod"!==this.config){let c="eggshell";c=s?"yellow":a?"red":"white",console.groupCollapsed("%c "+t+"."+n,`color: ${c}`),console.log("this:"),console.log(e),console.log("input:");for(var l=0;l<r.length;l++)console.log(r[l]);console.log(r),console.log("output:"),console.log(o),a&&console.log(i),console.groupEnd()}}do_not_log(){}do_log(){}}class t{dig(e,t,n){e.add(n);let r=Object.keys(n);for(let o=r.length,a=0;a<o;a++){let o=r[a],s=n[o];if(s&&!e.has(s))if("string"==typeof s)console.log(t.join("."),o,s);else if("object"==typeof s){let n=JSON.parse(JSON.stringify(t));n.push(o),dig(e,n,s)}}}detect_changes(e,t,n){let r=0;new MutationObserver((()=>{Date.now(),intervalc,r=Date.now()})).observe(e,{attributes:!0,childList:!0,subtree:!0}),setInterval((()=>{}),t),n()}inject_js(){let e=document.createElement("script");e.src=chrome.runtime.getURL("/js/injected.js"),document.documentElement.append(e)}async inject_css(){var e=await this.fetch_text(this.get_url("/css/content.css"));document.documentElement.append(this.html_to_element(`<style>${e}</style>`))}get_iframe_src(){return"dev"===this.config.mode?"http://localhost:2010/":chrome.runtime.getURL("/pages/app/index.html")}find_text_input(e){return Array.from(e.querySelectorAll("input, textarea")).filter((e=>"text"===e.type||"textarea"===e.type||"number"===e.type||"email"===e.type))[0]}constructor(t){this.config=t,this.log=new e(t)}get_url(e){return chrome.runtime.getURL(e)}get_value(e){let t=$(e).get(0);return t?"META"===t.tagName?t.getAttribute("content").trim():t.textContent.trim():"Not available"}async wait(e){return new Promise((t=>{setTimeout(t,e)}))}decode_json(e){try{return JSON.parse(e)}catch(e){return null}}clone(e){try{return JSON.parse(JSON.stringify(e))}catch(e){return null}}is_undefined(e){return void 0===e}list_is_empty(e){return 0===e.length}object_is_empty(e){return 0===Object.keys(e).length}async fetch_json(e,t){let n=await fetch(e,t),r=await n.text();try{return JSON.parse(r)}catch(e){return console.log("error"),console.log(e),null}}async fetch_text(e){let t=await fetch(e);return await t.text()}async wait_for_ready_state_complete(){for(;;){if("complete"===document.readyState)return;await this.wait(200)}}async wait_for_element(e){for(let t=0;t<1e3;t++){let t=document.querySelector(e);if(t)return t;await this.wait(100)}}simulate(e,t){e.dispatchEvent(new Event(t,{bubbles:!0}))}html_to_element(e){let t=document.createElement("div");return t.innerHTML=e,t.firstElementChild}run_complex_selector(e){if(e.root_css)(t=document.querySelector(e.root_css))||(t=document);else if(e.root_element)var t=e.root_element;else t=document;if(e.css)var n=Array.from(t.querySelectorAll(e.css));else n=Array.from(t.querySelectorAll("*"));if(e.inner_text)for(var r=n.length;r--;)n[r].innerText!==e.inner_text&&n.splice(r,1);if(e.inner_text_includes)for(r=n.length;r--;)!1===n[r].innerText.toLowerCase().includes(e.inner_text_includes)&&n.splice(r,1);if(e.style){var o=Object.keys(e.style),a=null;e:for(r=n.length;r--;){a=window.getComputedStyle(n[r]);for(var s=o.length;s--;)if(e.style[o[s]]!==a[o[s]]){n.splice(r,1);continue e}}}if(e.min_area)for(let t=n.length;t--;){let r=n[t].getBoundingClientRect();r.width*r.height<e.min_area&&n.splice(t,1)}return n}find_element(e){for(var t=0;t<e.length;t++){var n=this.run_complex_selector(e[t]);if(n&&n.length>0)return n[0]}return null}find_elements(e){for(var t=0;t<e.length;t++){var n=this.run_complex_selector(e[t]);return n&&n.length>0?n:[]}return null}bg_fetch(e,t){return new Promise((n=>{chrome.runtime.sendMessage({name:"fetch_json",data:{url:e,data:t}},(e=>{n(e)}))}))}create_iframe_wrap(e){let t=new Promise((t=>{let n=r=>{if(r.data&&"iframe_ready"===r.data.name&&e.contentWindow===r.source){console.log("iframe_ready",r.source);let e=r.source;window.removeEventListener("message",n),t(this.create_window_wrap(window,e))}};window.addEventListener("message",n)}));return{exec:(e,n)=>t.then((t=>t.exec(e,n)))}}create_window_wrap(e,t){let n=[];return e.addEventListener("message",(async e=>{if(e.data){let t=e.data.name,r=e.data.meta,o=e.data.data;"exec_result"===t&&r&&r.response&&n[r.request_id]&&n[r.request_id](o.result)}})),{exec:(e,r)=>new Promise((o=>{let a=n.length;n.push(o);let s={request_id:a,request:!0};t.postMessage({name:e,meta:s,data:r},"*")}))}}create_window_api(e){window.addEventListener("message",(async t=>{if(t.data){let n=t.data.name,r=t.data.meta,o=t.data.data;if(e[n]){let a=await e[n](o);t.source.postMessage({name:"exec_result",meta:{response:!0,request_id:r,request_id:r.request_id},data:{result:a}},"*")}}}))}create_runtime_api(e){chrome.runtime.onMessage.addListener((function(t,n,r){return console.log(e,t),e[t.name]?(t.data&&t.data._sender&&(t.data._sender=n),e[t.name](t.data).then(r)):r(null),!0}))}runtime_exec(e,t){return new Promise((n=>{chrome.runtime.sendMessage({name:e,data:t},n)}))}parse_rows(e){for(var t=[],n=null,r=e[0],o=1;o<e.length;o++){n={};for(var a=0;a<r.length;a++)n[r[a]]=e[o][a];t.push(n)}return t}get_methods(e){return Object.getOwnPropertyNames(e).filter((t=>"function"==typeof e[t]))}wrap_class(e,t){t=t||[];let n=this,r=e.name;this.get_methods(e.prototype).forEach((o=>{let a=e.prototype[o];e.prototype[o]=function(){let e={ignore:t.includes(o),obj:this,class_name:r,method_name:o,args:Array.from(arguments)},s=n.stubs;if(s&&s[0]&&s[0].class_name===r&&s[0].method_name===o)return e.stub=!0,e.output=s[0].output,s.splice(0,1),n.log.write_method_call(e),e.output;try{e.output=a.apply(this,arguments)}catch(t){e.error=!0,e.stack=t.stack,e.output=null}return e.output&&e.output.then?e.output=new Promise((t=>{e.output.then((r=>{e.output=r,n.log.write_method_call(e),t(r)})).catch((r=>{e.error=!0,e.stack=r.stack,e.output=null,n.log.write_method_call(e),t(null)}))})):n.log.write_method_call(e),e.output}}))}set_stubs(e){this.stubs=e}post_window_message(e,t,n){e.postMessage({name:t,data:n},"*")}blob_to_base64(e){return new Promise((t=>{const n=new FileReader;n.onloadend=()=>{t(n.result)},n.readAsDataURL(e)}))}download_string(e,t){var n=new Blob([e],{type:"text/plain"}),r=URL.createObjectURL(n),o=document.createElement("a");document.body.appendChild(o),o.style="display: none",o.href=r,o.download=t,o.click(),window.URL.revokeObjectURL(r)}download_blob(e,t){var n=URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.style="display: none",r.href=n,r.download=t,r.click(),window.URL.revokeObjectURL(n)}find(e,t,n){for(var r=0;r<e.length;r++)if(e[r][t]===n)return e[r];return null}update_object(e,t){Object.keys(t).forEach((n=>{null!==e[n]&&"object"==typeof e[n]?this.update_object(e[n],t[n]):e[n]=t[n]}))}rows_to_data_arr(e){for(var t=[],n=null,r=e[0],o=1;o<e.length;o++){n={};for(var a=0;a<r.length;a++)n[r[a]]=e[o][a];t.push(n)}return t}to_data_url(e){return new Promise((t=>{var n=new XMLHttpRequest;n.onload=function(){var e=new FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(n.response)},n.open("GET",e),n.responseType="blob",n.send()}))}}const n=new class{timeout(e){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}blob_to_base64(e){return new Promise(((t,n)=>{const r=new FileReader;r.onloadend=()=>t(r.result),r.readAsDataURL(e)}))}};!async function(){const e=navigator.mediaDevices.getUserMedia,r={is_with_api_fetch:!0,is_first_record:!0,is_audio_record_start:!1,origin_audio_stream:null,recorder_chuncks:[],audio_recorder:null,ac:null,merger:null,audio_node:null,audio_stream:null};function o(){window.window_wrap.exec("generete_record"),r.audio_node&&(r.audio_node.connect(r.merger,0,0),console.log("Connect")),async function(){const e=await async function(){return new Promise((async e=>{const t=new Audio;t.crossOrigin="anonymous",t.type="audio/mp3",t.addEventListener("ended",(function(){window.window_wrap.exec("stop_record_playing"),t.src="",t.removeEventListener("ended",this),r.is_audio_record_start=!1,r.recorder_chuncks=[],r.audio_recorder=null})),t.addEventListener("canplaythrough",(async function(){const n=new AudioContext,r=n.createMediaElementSource(t),o=n.createMediaStreamDestination();r.connect(o),t.play(),window.window_wrap.exec("play_record");const a=t.captureStream();t.removeEventListener("canplaythrough",this),e(a)}));const o=new Blob(r.recorder_chuncks,{type:"audio/ogg; codecs=opus"}),a=await async function(e){if(r.is_first_record){const e=document.getElementById("soundboard-mini-popup");window.window_parent=await window.util.create_window_wrap(window,e.contentWindow),r.is_first_record=!1}const t=await n.blob_to_base64(e),o=await window.window_wrap.exec("fetch_voice",t);console.log(o);const a=await window.window_parent.exec("fetch_base64",{base64:o});return URL.createObjectURL(a)}(o);t.src=a}))}();r.ac||(r.ac=new AudioContext,r.merger=r.ac.createChannelMerger(2)),console.log(e,"audio recorder stream"),r.ac.createMediaStreamSource(e).connect(r.merger,0,1)}()}window.util=new t,window.window_wrap=window.util.create_window_wrap(window,window.parent),window.addEventListener("message",(e=>{const t=e.data.reason;e.data.data,"key_press"===t&&async function(){const e=r.origin_audio_stream;if(!e)return;window.window_wrap.exec("start_record");const t=new MediaRecorder(e);t.ondataavailable=e=>{r.recorder_chuncks.push(e.data)},t.onstop=o,r.audio_recorder=t,r.audio_node.disconnect(),console.log("Disconnecttt"),t.start(),r.is_audio_record_start=!0}(),"key_up"===t&&r.audio_recorder&&"inactive"!==r.audio_recorder.state&&r.audio_recorder.stop()})),navigator.mediaDevices.getUserMedia=async function(t){const n=await e.apply(this,arguments);if(t.audio){const e=new AudioContext;r.ac=e;const t=e.createChannelMerger(2);r.merger=t,r.origin_audio_stream=n;const o=e.createMediaStreamSource(n);o.connect(t,0,0),r.audio_node=o;const a=e.createMediaStreamDestination();return t.connect(a),r.audio_stream=a.stream,a.stream}return n}}()})();